# 第三章：（实验）

动手实战Systemd
----
## 软件环境
- Ubuntu18.04
- Systemd
----
## 实验报告要求
- 根据老师所给两篇`systemd`入门教程完成操作
- 参照第2章作业的要求，完整实验操作过程通过`asciinema`进行录像并上传，文档通过`github`上传
- 在自己的`github`仓库上新建`markdown`格式纯文本文件附上`asciinema`的分享URL
- 提醒：避免在终端操作录像过程中暴漏密码、个人隐私等任何机密数据
----
## 实验过程
### step1：命令篇之系统管理
#### systemctl
`systemctl`是 Systemd 的主命令，用于管理系统。这部分无法进行录制，就跳过了^_^
    

#### systemd-analyze
`systemd-analyze`命令用于查看启动耗时。

[![asciicast](https://asciinema.org/a/BpE1y3JnRFwTKWgWwJZx19frG.png)](https://asciinema.org/a/BpE1y3JnRFwTKWgWwJZx19frG)


#### hostnamectl,localctl,timedatectl,loginctl
`hostnamectl`命令用于查看当前主机的信息。
`localectl`命令用于查看本地化设置。
`timedatectl`命令用于查看当前时区设置。
`loginctl`命令用于查看当前登录的用户。
(这部分操作比较简短，就录在一起了)

[![asciicast](https://asciinema.org/a/wmd5VJk8Jn8qNGdE7RXmTA6cX.png)](https://asciinema.org/a/wmd5VJk8Jn8qNGdE7RXmTA6cX)

### step2:systemd命令篇之Unit
不同的资源统称为 Unit（单位）。Unit共分为12种。
- Service unit：系统服务
- Target unit：多个 Unit 构成的一个组
- Device Unit：硬件设备
- Mount Unit：文件系统的挂载点
- Automount Unit：自动挂载点
- Path Unit：文件或路径
- Scope Unit：不是由 Systemd 启动的外部进程
- Slice Unit：进程组
- Snapshot Unit：Systemd 快照，可以切回某个快照
- Socket Unit：进程间通信的 socket
- Swap Unit：swap 文件
- Timer Unit：定时器
#### Unit的状态和管理
- `systemctl list-units`命令可以查看当前系统的所有 Unit。
- `systemctl status`命令用于查看系统状态和单个 Unit 的状态。
- `systemctl list-dependencies`命令列出一个 Unit 的所有依赖。
- 如果要展开 Target，就需要使用`--all`参数。

[![asciicast](https://asciinema.org/a/FCk0gixR9kRAOcn8t11LIHDue.png)](https://asciinema.org/a/FCk0gixR9kRAOcn8t11LIHDue)

[![asciicast](https://asciinema.org/a/v5SGBkjCeJUrFAFypX7pJLyxL.png)](https://asciinema.org/a/v5SGBkjCeJUrFAFypX7pJLyxL)

[![asciicast](https://asciinema.org/a/iOn1qbh531X3qRIns9FW2QQrp.png)](https://asciinema.org/a/iOn1qbh531X3qRIns9FW2QQrp)

#### Unit的配置文件
- `systemctl enable`命令用于在上面两个目录之间，建立符号链接关系。
- `systemctl enable`命令相当于激活开机启动。
- `systemctl enable`命令相当于激活开机启动。
- `systemctl list-unit-files`命令用于列出所有配置文件。
- `systemctl cat`命令可以查看配置文件的内容。

[![asciicast](https://asciinema.org/a/cSpoGDCZrK4WgcO9IiCXTc0H1.png)](https://asciinema.org/a/cSpoGDCZrK4WgcO9IiCXTc0H1)

### step3：命令篇之Target
Target 就是一个 Unit 组，包含许多相关的 Unit 。启动某个 Target 的时候，Systemd 就会启动里面所有的 Unit。从这个意义上说，Target 这个概念类似于"状态点"，启动某个 Target 就好比启动到某种状态。

[![asciicast](https://asciinema.org/a/vFOl5a3JmksYKhIBqIzwfNcfK.png)](https://asciinema.org/a/vFOl5a3JmksYKhIBqIzwfNcfK)

### step4：命令篇之日志管理
Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用`journalctl`一个命令，查看所有日志（内核日志和应用日志）。日志的配置文件是`/etc/systemd/journald.conf`。

[![asciicast](https://asciinema.org/a/YI1M6gkwZHL46CL4GBRsjljVe.png)](https://asciinema.org/a/YI1M6gkwZHL46CL4GBRsjljVe)

----
### step5：实战篇之开机启动、启动和停止服务

- `sudo systemctl enable somed`：开机启动某项服务
- `sudo systemctl status somed`：查看某项服务的状态
- `sudo systemctl start/stop/kill/restart somed.service`：启动/停止/杀死/重启某项服务

[![asciicast](https://asciinema.org/a/z7N2Ibth9hf5ziyT1ff7LA8Ve.png)](https://asciinema.org/a/z7N2Ibth9hf5ziyT1ff7LA8Ve)

### step6：实战篇之读懂配置文件
- `systemctl cat sshd.service`：用来查看某项服务的配置文件
- [Unit] 区块：启动顺序（`After`和`Before`字段）与依赖关系（`Wants`(弱依赖关系)和`Requires`(强依赖关系)）。
- [Service] 区块：启动行为
- `systemctl get-default`：查看默认启动的Target
- `systemctl cat multi-user.target`：查看Target的配置文件

[![asciicast](https://asciinema.org/a/CjXMDkyW3jbK96VOzLbcEhOKZ.png)](https://asciinema.org/a/CjXMDkyW3jbK96VOzLbcEhOKZ)

## 自查清单
- 如何添加一个用户并使其具备sudo执行程序的权限？
    - > sudo adduser[username]

- 如何将一个用户添加到一个用户组？
    - > 方法一：sudo adduser 
      >  [username] [groupname]
    - > 方法二：sudo username -a 
      >  [username] -G [groupname]
- 如何查看当前系统的分区表和文件系统详细信息？
    - 查看分区表：
        - `sudo sfdisk -l`：非交互式
        - `df -h`：只会列出已挂载的文件系统信息，对于没有挂载的文件系统是查看不到的。
        - `sudo parted -l`：可以对大于2TB的磁盘设备进行分区，以及创建GPT分区（而fdisk命令就办不到了）。
        - `lsblk -a`：列出系统的所有块设备及其逻辑分区。
        - `sudo fdisk -l`：列出指定设备的分区表，然后退出。
    - 查看文件系统详细信息：
        - `stat -f file`：查看file所在的文件系统信息
- 如何实现开机自动挂载Virtualbox的共享目录分区？
    - 在VirtualBox的配置中新建一个共享文件夹
    - 安装辅助工具包——是一个名为VBoxGuestAdditions.iso的映像文件，位于VirtualBox的安装目录下。点击“光驱”，加载映像。
    - 启动虚拟机，进行安装：
        - `mount /dev/cdrom`:挂载光驱
        - `cd /mnt/cdrom`:进入光盘
        - `sh ./VBoxLinuxAdditions.run vfs-module`：这里没有完全安装
        - `reboot`：安装成功后需重启系统
    - 重启后访问共享文件夹：
        - `mkdir /mnt/share`：新建挂载点
        - `mount -t vboxsf sharing /mnt/share`：挂载共享文件夹
        - `cd /mnt/share`:进入共享文件夹
- 基于LVM（逻辑分卷管理）的分区如何实现动态扩容和缩减容量？
    - 动态扩容：
        - > `lvextend -L +size /dev/dir`
    - 缩减容量：
        - > `lvreduce -L size /dev/dir`
- 如何通过systemd设置实现在网络连通时运行一个指定脚本，在网络断开时运行另一个脚本？
    - > #打开网络连通相关的Unit:   
      > `vim /usr/lib/systemd/system/systemd-network.service`
      > 
      > #在[service]中添加以下内容并
      > 保存退出   
      > `ExecStartPost=[My start 
      > script_Path]`
      >
      > `ExecStopPost=[My stop 
      > script_Path]`
      >
      > #重新加载配置文件:   
      > `sudo systemctl daemon-reload`
      >
      > #重启相关服务:   
      > `sudo systemctl restart   systemd-network.service`
      > 
      > #关闭相关服务:   
      > `sudo systemctl stop systemd-network.service`

- 如何通过systemd设置实现一个脚本在任何情况下被杀死之后会立即重新启动？实现杀不死？
    - 在`/lib/systemd/system`目录下建立运行指定脚本的配置文件KILLME.service
    - 添加如下内容：
        >[Unit]    
        >Description=KILL ME 
        >
        >[Service]   
        >Type=simple   
        >ExecStart=My_script_path   
        >ExecStopPost=My_script_path   
        >Restart=always   
        >RestartSec=1   
        >RemainAfterExit=yes   
        >
        >[Install]   
        >WantedBy=multi_user.target
    - 重新加载配置文件并重启相关服务：
        > #重新加载配置文件   
        > sudo systemctl daemon-reload
        >  
        > #重启服务   
        > sudo systemctl restart KILLME.service
        > 
        > #查看服务状态   
        > sudo systemctl is-active KILLME.service
        > 
        > #尝试杀死服务   
        > sudo systemctl kill KILLME.service
        >
        > #再次查看服务状态   
        > sudo systemctl is-active KILLME.service   
        >
        > #发现服务杀不死

### 参考文献
- [linux系统查看分区表](https://baijiahao.baidu.com/s?id=1620334302127468416&wfr=spider&for=pc)
- [在Linux中查看分区表的4种方法](https://www.linuxidc.com/Linux/2018-12/155877.htm)
- [VirtualBox 共享文件夹设置 及 开机自动挂载](https://www.cnblogs.com/52linux/archive/2012/03/07/2384381.html)